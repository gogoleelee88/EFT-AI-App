<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video DOM Guarantee Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .video-container { 
            background: #000; 
            border-radius: 12px; 
            overflow: hidden; 
            margin: 20px 0; 
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video { 
            width: 100%; 
            max-width: 640px; 
            transform: scaleX(-1);
            background: #000;
        }
        button { 
            padding: 12px 24px; 
            margin: 10px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 16px;
        }
        .start-btn { background: #4CAF50; color: white; }
        .test-btn { background: #2196F3; color: white; }
        .remove-btn { background: #f44336; color: white; }
        .console { 
            background: #f5f5f5; 
            padding: 20px; 
            border-radius: 8px; 
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video DOM ë³´ì¥ í…ŒìŠ¤íŠ¸</h1>
        <p>cam-test.htmlê³¼ ë™ì¼í•œ ì•ˆì •ì ì¸ ì¹´ë©”ë¼ êµ¬ë™ì„ ë©”ì¸ ì•±ì—ì„œë„ ë³´ì¥í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
        
        <div class="status" id="status">ì¤€ë¹„ ì¤‘...</div>
        
        <div class="video-container" id="videoHost">
            <!-- ë™ì ìœ¼ë¡œ video ìš”ì†Œê°€ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
        
        <div>
            <button class="start-btn" onclick="startCamera()">ğŸš€ ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°</button>
            <button class="test-btn" onclick="testVideoElement()">ğŸ” VIDEO ìš”ì†Œ í™•ì¸</button>
            <button class="remove-btn" onclick="removeVideoElement()">ğŸ—‘ï¸ VIDEO ìš”ì†Œ ì œê±° (ë¦¬ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸)</button>
        </div>
        
        <div>
            <h3>í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸:</h3>
            <ul>
                <li id="check1">âŒ "ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°" í´ë¦­ ì§í›„ ì½˜ì†”ì— VIDEO ref? true / VIDEO qs? true</li>
                <li id="check2">âŒ íƒ­ ì „í™˜/ìƒíƒœ ë³€ê²½ì—ë„ DOMì—ì„œ ì‚¬ë¼ì§€ì§€ ì•ŠìŒ (displayë§Œ ë³€ê²½)</li>
                <li id="check3">âŒ "video element still missing after mount" ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ</li>
            </ul>
        </div>
        
        <h3>ì½˜ì†” ë¡œê·¸:</h3>
        <div class="console" id="console"></div>
    </div>

    <script>
        let videoRef = null;
        let hostRef = document.getElementById('videoHost');
        let streamRef = null;
        
        // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
        function log(message) {
            const console = document.getElementById('console');
            console.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            console.scrollTop = console.scrollHeight;
            console.log(message);
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function setStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isError ? 'error' : 'success');
        }
        
        // Video element ë³´ì¥ í•¨ìˆ˜ (Calibration.tsxì™€ ë™ì¼í•œ ë¡œì§)
        function ensureVideoElement() {
            // 1. ê¸°ì¡´ ref í™•ì¸
            if (videoRef && document.contains(videoRef)) {
                return videoRef;
            }
            
            // 2. IDë¡œ DOM ê²€ìƒ‰
            const existingVideo = document.getElementById('testVideo');
            if (existingVideo && document.contains(existingVideo)) {
                videoRef = existingVideo;
                return existingVideo;
            }
            
            // 3. ë™ì  ìƒì„±
            if (hostRef) {
                log('ğŸ“¹ Creating video element dynamically');
                const video = document.createElement('video');
                video.id = 'testVideo';
                video.muted = true;
                video.setAttribute('playsInline', '');
                video.setAttribute('autoplay', '');
                video.style.cssText = 'transform: scaleX(-1); width: 100%; background: #000; visibility: visible; display: block;';
                
                // ê¸°ì¡´ video ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
                hostRef.querySelectorAll('video').forEach(v => v.remove());
                hostRef.appendChild(video);
                
                videoRef = video;
                return video;
            }
            
            throw new Error('Host container not available for video element creation');
        }
        
        // ì¹´ë©”ë¼ ì‹œì‘ í•¨ìˆ˜
        async function startCamera() {
            try {
                log('ğŸš€ Starting camera initialization...');
                setStatus('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘...', false);
                
                // microtask + nextFrame: DOMì— refê°€ ê½‚í ì‹œê°„ í™•ë³´
                await Promise.resolve();
                await new Promise(r => requestAnimationFrame(() => r()));
                
                // Video element ë³´ì¥
                const video = ensureVideoElement();
                
                // ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²€ì¦
                const hasVideoRef = !!videoRef;
                const hasVideoInDOM = !!document.getElementById('testVideo');
                
                log(`VIDEO ref? ${hasVideoRef}`);
                log(`VIDEO qs? ${hasVideoInDOM}`);
                
                // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                if (hasVideoRef && hasVideoInDOM) {
                    document.getElementById('check1').innerHTML = 'âœ… "ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°" í´ë¦­ ì§í›„ ì½˜ì†”ì— VIDEO ref? true / VIDEO qs? true';
                    document.getElementById('check3').innerHTML = 'âœ… "video element still missing after mount" ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ';
                }
                
                // ì¹´ë©”ë¼ ì‹œì‘
                if (streamRef) {
                    streamRef.getTracks().forEach(track => track.stop());
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720, facingMode: 'user' },
                    audio: false
                });
                
                video.srcObject = stream;
                streamRef = stream;
                
                await video.play().catch(() => {
                    log('ğŸ”„ Play failed, but continuing...');
                });
                
                log('âœ… Camera started successfully');
                setStatus('ì¹´ë©”ë¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', false);
                
            } catch (error) {
                log('ğŸš¨ Camera failed: ' + error.message);
                setStatus('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨: ' + error.message, true);
            }
        }
        
        // Video ìš”ì†Œ í™•ì¸
        function testVideoElement() {
            const hasVideoRef = !!videoRef;
            const hasVideoInDOM = !!document.getElementById('testVideo');
            const isInDocument = videoRef ? document.contains(videoRef) : false;
            
            log(`ğŸ” Video Element Status:`);
            log(`  - videoRef exists: ${hasVideoRef}`);
            log(`  - DOM element exists: ${hasVideoInDOM}`);
            log(`  - Element in document: ${isInDocument}`);
            
            if (hasVideoRef && hasVideoInDOM && isInDocument) {
                setStatus('Video ìš”ì†Œê°€ ì •ìƒì ìœ¼ë¡œ ì¡´ì¬í•©ë‹ˆë‹¤!', false);
            } else {
                setStatus('Video ìš”ì†Œì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤!', true);
            }
        }
        
        // Video ìš”ì†Œ ì œê±° (ë¦¬ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸)
        function removeVideoElement() {
            log('ğŸ—‘ï¸ Removing video element for remount test...');
            
            if (videoRef && videoRef.parentNode) {
                videoRef.parentNode.removeChild(videoRef);
                videoRef = null;
            }
            
            const domVideo = document.getElementById('testVideo');
            if (domVideo && domVideo.parentNode) {
                domVideo.parentNode.removeChild(domVideo);
            }
            
            log('Video element removed. Click "ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°" to test remount.');
            setStatus('Video ìš”ì†Œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ë¦¬ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë‹¤ì‹œ ì‹œì‘í•´ë³´ì„¸ìš”.', false);
        }
        
        // íƒ­ ì „í™˜ ê°ì§€
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                log('ğŸ“± Tab hidden - video should remain in DOM');
                document.getElementById('check2').innerHTML = 'ğŸ”„ íƒ­ ì „í™˜ í…ŒìŠ¤íŠ¸ ì¤‘... (íƒ­ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì„¸ìš”)';
            } else {
                log('ğŸ“± Tab visible - checking video DOM stability');
                const videoStillExists = !!document.getElementById('testVideo');
                if (videoStillExists) {
                    log('âœ… Video element survived tab switch!');
                    document.getElementById('check2').innerHTML = 'âœ… íƒ­ ì „í™˜/ìƒíƒœ ë³€ê²½ì—ë„ DOMì—ì„œ ì‚¬ë¼ì§€ì§€ ì•ŠìŒ (displayë§Œ ë³€ê²½)';
                } else {
                    log('âŒ Video element lost during tab switch!');
                    document.getElementById('check2').innerHTML = 'âŒ íƒ­ ì „í™˜ ì‹œ VIDEO ìš”ì†Œê°€ ì‚¬ë¼ì§!';
                }
            }
        });
        
        log('Test page loaded. Ready for video DOM guarantee testing.');
        setStatus('í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ. "ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°"ë¥¼ í´ë¦­í•˜ì„¸ìš”.', false);
    </script>
</body>
</html>